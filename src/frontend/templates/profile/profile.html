{% extends "base.html" %}
{% load static %}

{% block title %}Profilo{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
<style>
  .profile-avatar, .avatar-container {
    width: 60px !important;
    height: 60px !important;
  }
</style>
{% endblock %}

{% block nav_mobile %}
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
	aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
	<span class="navbar-toggler-icon"></span>
</button>
{% endblock %}

{% block nav_elements %}
<li class="nav-item">
	<a class="nav-link text-dark" href="{% url 'home' %}">Home</a>
</li>
<li class="nav-item">
	<a class="nav-link text-dark active" href="{% url 'profile' %}">Profilo</a>
</li>
<li class="nav-item">
	<a class="nav-link text-dark" href="{% url 'preferences' %}">Preferenze</a>
</li>
<li class="nav-item">
	<a class="nav-link text-dark" href="{% url 'accreditation' %}">Accreditazione</a>
</li>
<li class="nav-item ms-3">
	<a class="btn login-btn px-3 py-1" href="{% url 'logout' %}">Logout</a>
</li>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="profile-header mb-5 text-center">
    <div class="profile-banner"></div>
    <div class="profile-overlay animate__animated animate__fadeIn">
      <h1 class="display-4 fw-bold">Il tuo Profilo</h1>
      <p class="lead">Gestisci i tuoi dati e visualizza il tuo QR code</p>
    </div>
  </div>

  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row g-4">
      <!-- Colonna sinistra - Informazioni personali -->
      <div class="col-lg-8">
        <div class="card profile-card shadow-sm mb-4 animate__animated animate__fadeInUp">
          <div class="card-header bg-transparent">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <div class="profile-icon me-3">
                  <i class="bi bi-person-circle"></i>
                </div>
                <div>
                  <h4 class="mb-0">Informazioni Personali</h4>
                  <p class="text-muted small mb-0">Gestisci i tuoi dati personali</p>
                </div>
              </div>
              <button class="btn btn-outline-primary rounded-pill section-edit-btn" type="button" data-section="personal">
                <i class="btn-icon bi bi-pencil me-2"></i><span class="btn-text">Modifica</span>
              </button>
            </div>
          </div>
          
          <div class="card-body">
            <ul class="list-group list-group-flush profile-list">
              <!-- Avatar -->
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 pb-3 profile-item-hover">
                <div class="d-flex align-items-center">
                  <div class="avatar-container me-3">
                    <img id="avatar-display" src="{{ current_user.propic.url }}" class="rounded-circle profile-avatar" alt="Avatar" style="width: 60px; height: 60px;">
                  </div>
                  <div>
                    <strong class="d-block">Avatar</strong>
                    <small class="text-muted">La tua immagine del profilo</small>
                  </div>
                </div>

              </li>              <!-- First Name -->
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 pb-3 profile-item-hover">
                <div>
                  <strong class="d-block">Nome</strong>
                  <span id="display-first_name" class="profile-data">{{ current_user.first_name }}</span>
                </div>
              </li>
              
              <!-- Last Name -->
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 pb-3 profile-item-hover">
                <div>
                  <strong class="d-block">Cognome</strong>
                  <span id="display-last_name" class="profile-data">{{ current_user.last_name }}</span>
                </div>
              </li>
              
              <!-- Email -->
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 pb-3 profile-item-hover">
                <div>
                  <strong class="d-block">Email</strong>
                  <span id="display-email" class="profile-data">{{ current_user.email }}</span>
                </div>
              </li>
              
              <!-- Form sezione personale (nascosto) -->
              <div class="collapse px-3 pt-3 mb-3 profile-edit-form" id="collapse-personal-info">
                <div class="form-section-title mb-3">Modifica informazioni personali</div>
                <!-- Avatar -->
                <div class="form-group mb-3">
                  <label class="form-label fw-bold mb-2">Immagine profilo</label>
                  <div class="d-flex align-items-center mb-2">
                    <img id="avatar-display" src="{{ current_user.propic.url }}" class="rounded-circle profile-avatar me-3" alt="Avatar" style="width: 60px; height: 60px;">
                    <div class="form-control-custom flex-grow-1">{{ form.propic }}</div>
                  </div>
                </div>
                
                <!-- First Name -->
                <div class="form-group mb-3">
                  <label class="form-label fw-bold mb-2">Nome</label>
                  <div class="form-control-custom">{{ form.first_name }}</div>
                </div>
                
                <!-- Last Name -->
                <div class="form-group mb-3">
                  <label class="form-label fw-bold mb-2">Cognome</label>
                  <div class="form-control-custom">{{ form.last_name }}</div>
                </div>
                
                <!-- Email -->
                <div class="form-group mb-3">
                  <label class="form-label fw-bold mb-2">Email</label>
                  <div class="form-control-custom">{{ form.email }}</div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                  <button type="button" class="btn btn-secondary me-2 section-cancel-btn" data-section="personal">
                    <i class="bi bi-x-circle me-2"></i>Annulla
                  </button>
                  <button type="button" class="btn btn-success section-save-btn" data-section="personal">
                    <i class="bi bi-check-circle me-2"></i>Salva modifiche
                  </button>
                </div>
              </div>
            </ul>
          </div>
        </div>
        
        <div class="card profile-card shadow-sm animate__animated animate__fadeInUp animate__delay-1s">
          <div class="card-header bg-transparent">
            <div class="d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <div class="profile-icon me-3">
                  <i class="bi bi-mortarboard-fill"></i>
                </div>
                <div>
                  <h4 class="mb-0">Informazioni Accademiche</h4>
                  <p class="text-muted small mb-0">Gestisci le tue informazioni universitarie</p>
                </div>
              </div>
              <button class="btn btn-outline-primary rounded-pill section-edit-btn" type="button" data-section="academic">
                <i class="btn-icon bi bi-pencil me-2"></i><span class="btn-text">Modifica</span>
              </button>
            </div>
          </div>
          
          <div class="card-body">
            <ul class="list-group list-group-flush profile-list">
              <!-- University -->
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 pb-3 profile-item-hover">
                <div>
                  <strong class="d-block">Universit√†</strong>
                  {% if current_user.university.name %}
                    <span id="display-university" class="profile-data">{{ current_user.university.name }}</span>
                  {% else %}
                    <span id="display-university" class="profile-data text-muted">Non specificata</span>
                  {% endif %}
                </div>

              </li>              <!-- Economical Level -->
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 pb-3 profile-item-hover">
                <div>
                  <strong class="d-block">Livello Economico</strong>
                  {% if current_user.economical_level %}
                    <span id="display-economical_level" class="profile-data">{{ current_user.economical_level.name }}</span>
                  {% else %}
                    <span id="display-economical_level" class="profile-data text-muted">Non specificato</span>
                  {% endif %}
                </div>
              </li>                  <!-- Allergens -->
              <li class="list-group-item d-flex justify-content-between align-items-center border-0 pb-3 profile-item-hover">
                <div style="width: 100%;">
                  <strong class="d-block">Allergie</strong>
                  {% if current_user.suffers_from.all %}
                    <div class="allergen-tags">
                      {% for allergen in current_user.suffers_from.all %}
                        <span class="allergen-tag">
                          {{ allergen.name }}
                        </span>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span class="profile-data text-muted">Nessuna allergia registrata</span>
                  {% endif %}
                </div>
              </li>
              
              <!-- Form sezione accademica (nascosto) -->
              <div class="collapse px-3 pt-3 mb-3 profile-edit-form" id="collapse-academic-info">
                <div class="form-section-title mb-3">Modifica informazioni accademiche</div>
                
                <!-- University -->
                <div class="form-group mb-3">
                  <label class="form-label fw-bold mb-2">Universit√†</label>
                  <div class="form-control-custom">
                    <div class="select-with-icon">
                      <i class="bi bi-buildings-fill select-icon"></i>
                      {{ form.university }}
                    </div>
                  </div>
                </div>
                
                <!-- Economical Level -->
                <div class="form-group mb-3">
                  <label class="form-label fw-bold mb-2">Livello Economico</label>
                  <div class="form-control-custom">
                    <div class="select-with-icon">
                      <i class="bi bi-currency-euro select-icon"></i>
                      {{ form.economical_level }}
                    </div>
                  </div>
                </div>
                
                <!-- Allergens -->
                <div class="form-group mb-3">
                  <label class="form-label fw-bold mb-2">
                    <i class="bi bi-exclamation-triangle me-2" style="color: #6a11cb;"></i>Allergie
                  </label>
                  <div class="form-control-custom">
                    <div class="select-with-allergens">
                      {{ form.suffers_from }}
                      <small class="allergen-helper text-muted mt-2 d-block">
                        <i class="bi bi-info-circle me-1"></i>Seleziona pi√π allergie tenendo premuto Ctrl (o Cmd su Mac)
                      </small>
                    </div>
                  </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                  <button type="button" class="btn btn-secondary me-2 section-cancel-btn" data-section="academic">
                    <i class="bi bi-x-circle me-2"></i>Annulla
                  </button>
                  <button type="button" class="btn btn-success section-save-btn" data-section="academic">
                    <i class="bi bi-check-circle me-2"></i>Salva modifiche
                  </button>
                </div>
              </div>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Colonna destra - QR Code -->
      <div class="col-lg-4">
        <div class="card profile-card shadow-sm h-100 animate__animated animate__fadeInRight">
          <div class="card-header bg-transparent">
            <div class="d-flex align-items-center">
              <div class="profile-icon me-3">
                <i class="bi bi-qr-code"></i>
              </div>
              <div>
                <h4 class="mb-0">QR Code Personale</h4>
                <p class="text-muted small mb-0">Per l'accreditamento alle mense</p>
              </div>
            </div>
          </div>
          <div class="card-body d-flex flex-column align-items-center justify-content-center">
            <div id="qrcode-container" class="text-center mb-4">
              <div class="qrcode-wrapper">
                <img id="qrcode-img" src="{% url 'profile_qrcode' %}" alt="QR Code" class="img-fluid qrcode-image">
              </div>
              <p class="qrcode-text mt-3">
                <small class="text-muted">
                  <i class="bi bi-info-circle me-2"></i>Il QR code si aggiorna automaticamente ogni minuto
                </small>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
  </form>
</div>

<script>
  // Aggiungi bootstrap icons se non √® gi√† presente
  if (!document.querySelector('link[href*="bootstrap-icons"]')) {
    const iconLink = document.createElement('link');
    iconLink.rel = 'stylesheet';
    iconLink.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css';
    document.head.appendChild(iconLink);
  }
  
  // Aggiungi animate.css se non √® gi√† presente
  if (!document.querySelector('link[href*="animate.css"]')) {
    const animateLink = document.createElement('link');
    animateLink.rel = 'stylesheet';
    animateLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css';
    document.head.appendChild(animateLink);
  }

  // Preview avatar
  document.querySelector('input[name="propic"]').addEventListener('change', function(e) {
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById('avatar-display').src = ev.target.result;
      // Aggiungi animazione quando cambi avatar
      const avatar = document.getElementById('avatar-display');
      avatar.classList.add('animate__animated', 'animate__pulse');
      setTimeout(() => {
        avatar.classList.remove('animate__animated', 'animate__pulse');
      }, 1000);
    };
    reader.readAsDataURL(e.target.files[0]);
  });
  
  // Refresh QR code ogni minuto con animazione
  setInterval(() => {
    const qrcode = document.getElementById('qrcode-img');
    const qrcodeWrapper = qrcode.closest('.qrcode-wrapper');
    qrcodeWrapper.classList.add('loading');
    
    // Crea nuovo src con timestamp
    const newSrc = `{% url 'profile_qrcode' %}?t=${Math.floor(Date.now()/60000)}`;
    
    // Quando la nuova immagine √® caricata, rimuovi classe loading e aggiungi animazione pulse
    qrcode.onload = () => {
      qrcodeWrapper.classList.remove('loading');
      qrcode.classList.add('animate__animated', 'animate__pulse');
      setTimeout(() => {
        qrcode.classList.remove('animate__animated', 'animate__pulse');
      }, 1000);
    };
    
    qrcode.src = newSrc;
  }, 60000);
  
  // Aggiungi effetti di hover e focus sui form elements
  document.querySelectorAll('.profile-edit-form input, .profile-edit-form select').forEach(el => {
    el.addEventListener('focus', function() {
      this.closest('.form-control-custom').classList.add('focused');
    });
    el.addEventListener('blur', function() {
      this.closest('.form-control-custom').classList.remove('focused');
    });
    
    // Aggiungiamo classi speciali per i select
    if (el.tagName === 'SELECT') {
      // Aggiungiamo un effetto di apertura
      el.addEventListener('mousedown', function() {
        this.classList.add('select-active');
      });
      
      // Stilizzare le opzioni al passaggio del mouse (per select multipli)
      if (el.multiple) {
        const options = el.querySelectorAll('option');
        options.forEach(option => {
          option.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(2px)';
          });
          option.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
          });
        });
      }
    }
  });
  
  // Animazione per i bottoni di modifica
  document.querySelectorAll('.profile-item-hover').forEach(item => {
    item.addEventListener('mouseenter', function() {
      const btn = this.querySelector('.btn');
      btn.classList.add('btn-hover');
    });
    item.addEventListener('mouseleave', function() {
      const btn = this.querySelector('.btn');
      btn.classList.remove('btn-hover');
    });
  });
  
  // Animazione per i form al collasso/espandere
  document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(btn => {
    const targetId = btn.getAttribute('data-bs-target').substring(1);
    const target = document.getElementById(targetId);
    
    target.addEventListener('show.bs.collapse', function() {
      this.classList.add('show');
    });
    
    target.addEventListener('hide.bs.collapse', function() {
      this.classList.remove('show');
    });
    
    // Aggiungi classi necessarie per transizioni fluide
    target.classList.add('profile-edit-form');
  });
  
  // Animazione speciale per la selezione allergeni
  const allergensSelect = document.querySelector('select[name="suffers_from"]');
  if (allergensSelect) {
    allergensSelect.addEventListener('change', function() {
      const selectedCount = Array.from(this.selectedOptions).length;
      
      // Aggiorniamo il testo di aiuto
      const helperText = this.closest('.form-control-custom').querySelector('.allergen-helper');
      if (helperText) {
        if (selectedCount > 0) {
          helperText.innerHTML = `<i class="bi bi-check-circle-fill me-1" style="color: #20bf55;"></i>Hai selezionato ${selectedCount} ${selectedCount === 1 ? 'allergia' : 'allergie'}`;
        } else {
          helperText.innerHTML = `<i class="bi bi-info-circle me-1"></i>Seleziona pi√π allergie tenendo premuto Ctrl (o Cmd su Mac)`;
        }
      }
      
      // Aggiungiamo effetto animato
      this.classList.add('select-changed');
      setTimeout(() => {
        this.classList.remove('select-changed');
      }, 800);
    });
  }
  
  // Gestione pulsanti modifica per sezioni
  document.querySelectorAll('.section-edit-btn').forEach(btn => {
    const section = btn.getAttribute('data-section');
    const target = document.getElementById(`collapse-${section}-info`);
    
    // Inizializza il collapsible con l'opzione toggle false
    let collapse;
    try {
      collapse = new bootstrap.Collapse(target, { toggle: false });
    } catch (e) {
      console.error(`Errore nell'inizializzazione del collapse per ${section}:`, e);
      // In caso di errore, crea un elemento fittizio per evitare errori
      collapse = {
        show: function() { 
          target.classList.add('show');
        },
        hide: function() {
          target.classList.remove('show');
        }
      };
    }
    
    // Event listener principale per il pulsante modifica/salva
    btn.addEventListener('click', function(e) {
      e.preventDefault(); // Previene l'invio del form o altre azioni predefinite
      
      // Controlla se il pulsante √® gi√† in modalit√† modifica
      const isEditMode = btn.getAttribute('data-edit-mode') === 'true';
      
      if (!isEditMode) {
        // MODALIT√Ä MODIFICA: Mostra il form di modifica della sezione
        try {
          collapse.show();
          
          // Cambiamo stile del pulsante
          btn.classList.remove('btn-outline-primary');
          btn.classList.add('btn-success');
          btn.querySelector('.btn-icon').classList.remove('bi-pencil');
          btn.querySelector('.btn-icon').classList.add('bi-check-lg');
          btn.querySelector('.btn-text').textContent = 'Salva';
          
          // Aggiungiamo un attributo per tenere traccia dello stato
          btn.setAttribute('data-edit-mode', 'true');
        } catch (error) {
          console.error('Errore durante la visualizzazione del form:', error);
        }
      } else {
        // MODALIT√Ä SALVA: Invia il form per salvare le modifiche
        e.stopPropagation(); // Ferma la propagazione per evitare che venga gestito come toggle
        
        // Mostra animazione di caricamento
        const loadingSpinner = document.createElement('div');
        loadingSpinner.className = 'spinner-border spinner-border-sm text-light ms-2';
        loadingSpinner.setAttribute('role', 'status');
        loadingSpinner.innerHTML = '<span class="visually-hidden">Caricamento...</span>';
        btn.appendChild(loadingSpinner);
        btn.disabled = true;
        
        // Aggiungi un campo nascosto al form per indicare la sezione
        const sectionInput = document.createElement('input');
        sectionInput.type = 'hidden';
        sectionInput.name = 'update_section';
        sectionInput.value = section;
        document.querySelector('form').appendChild(sectionInput);
        
        try {
          // Invia il form
          document.querySelector('form').submit();
        } catch (error) {
          console.error('Errore durante l\'invio del form:', error);
          btn.removeChild(loadingSpinner);
          btn.disabled = false;
          showNotification('Errore durante il salvataggio dei dati', 'danger');
        }
      }
    });
  });
  
  // Event listener per i pulsanti di annullamento
  document.querySelectorAll('.section-cancel-btn').forEach(btn => {
    const section = btn.getAttribute('data-section');
    const target = document.getElementById(`collapse-${section}-info`);
    const editBtn = document.querySelector(`.section-edit-btn[data-section="${section}"]`);
    
    let collapse;
    try {
      collapse = bootstrap.Collapse.getInstance(target) || new bootstrap.Collapse(target, { toggle: false });
    } catch (e) {
      console.error(`Errore nell'inizializzazione del collapse per cancel ${section}:`, e);
      collapse = {
        hide: function() { 
          target.classList.remove('show'); 
        }
      };
    }
    
    btn.addEventListener('click', function(e) {
      e.preventDefault(); // Previene l'invio del form
      
      // Nascondi il form
      try {
        collapse.hide();
        
        // Ripristina lo stile originale del pulsante modifica
        editBtn.classList.remove('btn-success');
        editBtn.classList.add('btn-outline-primary');
        editBtn.querySelector('.btn-icon').classList.add('bi-pencil');
        editBtn.querySelector('.btn-icon').classList.remove('bi-check-lg');
        editBtn.querySelector('.btn-text').textContent = 'Modifica';
        editBtn.setAttribute('data-edit-mode', 'false');
        
        // Ripristina i valori originali nel form
        setTimeout(() => {
          // Reset del form - Resetta i campi agli ultimi valori salvati
          const form = document.querySelector('form');
          if (form) {
            form.reset();
          }
          
          // Se c'√® un'immagine profilo, ripristina l'anteprima originale
          if (section === 'personal') {
            document.querySelectorAll('#avatar-display').forEach(img => {
              img.src = "{{ current_user.propic.url }}";
            });
          }
        }, 300);
      } catch (error) {
        console.error('Errore durante la chiusura del form:', error);
      }
    });
  });
  
  // Event listener per i pulsanti di salvataggio all'interno dei form
  document.querySelectorAll('.section-save-btn').forEach(btn => {
    const section = btn.getAttribute('data-section');
    const editBtn = document.querySelector(`.section-edit-btn[data-section="${section}"]`);
    
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Simula il click sul pulsante di modifica/salva principale
      if (editBtn && editBtn.getAttribute('data-edit-mode') === 'true') {
        editBtn.click();
      }
    });
  });
  
  // Effetto ripple per i pulsanti
  document.querySelectorAll('.btn').forEach(button => {
    button.addEventListener('click', function(e) {
      const x = e.clientX - e.target.getBoundingClientRect().left;
      const y = e.clientY - e.target.getBoundingClientRect().top;
      
      const ripple = document.createElement('span');
      ripple.className = 'ripple';
      ripple.style.left = `${x}px`;
      ripple.style.top = `${y}px`;
      
      this.appendChild(ripple);
      
      setTimeout(() => {
        ripple.remove();
      }, 600);
    });
  });
  
  // Funzione per mostrare notifiche
  function showNotification(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    const toastContent = document.createElement('div');
    toastContent.className = 'd-flex';
    
    const toastBody = document.createElement('div');
    toastBody.className = 'toast-body';
    toastBody.textContent = message;
    
    const closeButton = document.createElement('button');
    closeButton.type = 'button';
    closeButton.className = 'btn-close btn-close-white me-2 m-auto';
    closeButton.setAttribute('data-bs-dismiss', 'toast');
    closeButton.setAttribute('aria-label', 'Close');
    
    toastContent.appendChild(toastBody);
    toastContent.appendChild(closeButton);
    toast.appendChild(toastContent);
    
    // Crea un toast container se non esiste
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
      document.body.appendChild(toastContainer);
    }
    
    toastContainer.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Rimuovi il toast dopo che √® stato nascosto
    toast.addEventListener('hidden.bs.toast', function() {
      toast.remove();
    });
  }
</script>
{% endblock %}
