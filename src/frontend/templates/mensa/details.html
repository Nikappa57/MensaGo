{% extends 'base.html' %}
{% load static %}

{% block title %}{{ mensa.name }}{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="{% static 'css/mensa-details.css' %}">
{% endblock %}

{% block nav_elements %}
{% if user.is_authenticated %}
<li class="nav-item dropdown ms-3">
	<a class="nav-link dropdown-toggle profile-btn px-3 py-1" href="#" id="navbarDropdown" role="button"
		data-bs-toggle="dropdown" aria-expanded="false">
		{{ user.first_name }} {{ user.last_name }}
	</a>
	<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
		<li><a class="dropdown-item" href="{% url 'profile' %}">Profile</a></li>
		<li><a class="dropdown-item" href="{% url 'preferences' %}">Preferences</a></li>
		<li><a class="dropdown-item" href="{% url 'accreditation' %}">Accreditation</a></li>
		<li><hr class="dropdown-divider"> </li>
		<li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
	</ul>
</li>
{% else %}
<li class="nav-item ms-3">
	<a class="btn login-btn px-3 py-1" href="{% url 'login' %}">Log In</a>
</li>
{% endif %}
{% endblock %}

{% block nav_mobile %}
{% if user.is_authenticated %}
<div class="dropdown d-lg-none">
	<a class="nav-link dropdown-toggle profile-btn px-3 py-1" href="#" id="navbarDropdown" role="button"
		data-bs-toggle="dropdown" aria-expanded="false">
		{{ user.first_name }} {{ user.last_name }}
	</a>
	
	<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown" style="margin: 0">
		<li><a class="dropdown-item" href="{% url 'profile' %}">Profile</a></li>
		<li><a class="dropdown-item" href="{% url 'preferences' %}">Preferences</a></li>
		<li><a class="dropdown-item" href="{% url 'accreditation' %}">Accreditation</a></li>
		<li><hr class="dropdown-divider"> </li>
		<li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
	</ul>
</div>
{% else %}
<li class="nav-item ms-3">
	<a class="btn login-btn px-3 py-1" href="{% url 'login' %}">Log In</a>
</li>
{% endif %}
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Restaurant Banner -->
<section class="restaurant-banner">
	<img src="{{ mensa.banner.url }}" alt="{{ mensa.name }}">
	<div class="restaurant-banner-overlay">
		<div class="container">
			<h1 class="fs-2 fw-bold">{{ mensa.name }}</h1>
			<p class="mb-0">
				<i class="fa-solid fa-location-dot me-2"></i>
				{{ mensa.position }}, {{ mensa.city.name }}
			</p>
			<span class="badge bg-light text-dark me-2 mt-3">
				{% for _ in "01234" %}
					{% if forloop.counter <= mensa.stars|default:0 %}
						<i class="fas fa-star text-warning"></i>
					{% else %}
						<i class="far fa-star text-muted"></i>
					{% endif %}
				{% endfor %}
				{{ mensa.review_set.all|length }} Reviews
			</span>
		</div>
	</div>
</section>

<div class="container py-4">
	<div class="row flex-column-reverse flex-lg-row">
		<!-- Left column - About, Location, Gallery -->
		<div class="col-lg-8">
			<!-- About Section -->
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">La nostra storia</small>
				<h2 class="section-title">About</h2>
				<p>{{ mensa.description }}</p>
			</div>
			
			<!-- Location Section -->
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">Dove ci troviamo</small>
				<h2 class="section-title">Location</h2>
				<div id="map" class="map-container">
					<!-- Map will be rendered here by Leaflet -->
				</div>
			</div>

			<!-- Weekly Menu Section -->
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">La nostra settimana culinaria</small>
				<h2 class="section-title">Menu Settimanale</h2>
				
				{% if weekly_menus %}
					<div class="text-start mb-4">
						<p class="text-muted mb-0">Scopri cosa offriamo giorno per giorno nella nostra mensa.<br>Menu freschi preparati con ingredienti di qualità.</p>
					</div>
					
					<!-- Menu Tabs for Days -->
					<div class="menu-tab-container">
						{% for weekday, day_data in weekly_menus.items %}
						<button class="menu-tab {% if day_data.is_today %}active{% endif %} {% if not day_data.is_open %}disabled{% endif %}" 
								id="day-tab-{{ weekday }}"
								{% if day_data.is_open %}onclick="switchDay('{{ weekday }}', this)"{% endif %}
								type="button"
								{% if not day_data.is_open %}disabled{% endif %}>
							{{ day_data.name }}
							{% if day_data.is_today %}
								<span class="ms-1 badge bg-primary rounded-pill">Oggi</span>
							{% endif %}
							{% if not day_data.is_open %}
								<span class="ms-1 badge bg-secondary rounded-pill">Chiuso</span>
							{% endif %}
						</button>
						{% endfor %}
					</div>
					
					<!-- Menu Content per Day -->
					<div class="menu-container">
						{% for weekday, day_data in weekly_menus.items %}
						<div id="menu-day-{{ weekday }}" class="menu-content {% if day_data.is_today %}active{% endif %}">
							{% if day_data.is_open and day_data.menus %}
								<!-- Meal tabs: Always show both Pranzo and Cena -->
								<div class="meal-tab-container">
									<!-- Pranzo button -->
									<button class="meal-tab {% if 0 in day_data.available_dayparts %}{% if forloop.first %}active{% endif %}{% else %}disabled{% endif %}" 
											{% if 0 in day_data.available_dayparts %}onclick="switchMeal('{{ weekday }}', '0', this)"{% else %}disabled{% endif %}>
										<i class="fa-solid fa-sun me-1"></i>Pranzo
										{% if 0 not in day_data.available_dayparts %}
											<span class="ms-1 badge bg-secondary rounded-pill">Chiuso</span>
										{% endif %}
									</button>
									<!-- Cena button -->
									<button class="meal-tab {% if 1 in day_data.available_dayparts %}{% if 0 not in day_data.available_dayparts %}active{% endif %}{% else %}disabled{% endif %}" 
											{% if 1 in day_data.available_dayparts %}onclick="switchMeal('{{ weekday }}', '1', this)"{% else %}disabled{% endif %}>
										<i class="fa-solid fa-moon me-1"></i>Cena
										{% if 1 not in day_data.available_dayparts %}
											<span class="ms-1 badge bg-secondary rounded-pill">Chiuso</span>
										{% endif %}
									</button>
								</div>

								<div class="meal-content-wrapper">
									{% for menu in day_data.menus %}
									<div id="meal-{{ weekday }}-{{ menu.day_part_value }}" class="meal-content {% if forloop.first %}active{% endif %}">
										{% for dish_type, dishes in menu.dishes_by_type.items %}
										<div class="course-section">
											{% if dish_type == "Primo" %}
											<h3 class="menu-category">Primi Piatti</h3>
											{% elif dish_type == "Secondo" %}
											<h3 class="menu-category">Secondi Piatti</h3>
											{% elif dish_type == "Contorno" %}
											<h3 class="menu-category">Contorni</h3>
											{% elif dish_type == "Dessert/Frutta" %}
											<h3 class="menu-category">Dessert e Frutta</h3>
											{% endif %}
											<div class="dish-grid">
												{% for dish in dishes %}
												<div class="dish-card">
													{% if dish.img %}
													<div class="dish-photo">
														<img src="{{ dish.img.url }}" alt="{{ dish.name }}">
													</div>
													{% endif %}
													<div class="dish-desc">
														<div class="dish-title">
															{{ dish.name }}
															{% if user.is_authenticated %}
																{% if dish in current_user.likes.all %}
																	<i class="fa-solid fa-heart text-danger ms-1 like-heart" 
																	   data-dish-id="{{ dish.name }}" 
																	   data-liked="true" 
																	   style="cursor: pointer;" 
																	   title="Rimuovi dai preferiti"></i>
																{% else %}
																	<i class="fa-regular fa-heart text-muted ms-1 like-heart" 
																	   data-dish-id="{{ dish.name }}" 
																	   data-liked="false" 
																	   style="cursor: pointer;" 
																	   title="Aggiungi ai preferiti"></i>
																{% endif %}
															{% endif %}
														</div>
														<div class="dish-ingredients">{{ dish.description }}</div>
														{% if dish.allergens.exists %}
														<div class="dish-allergens">
															{% for allergen in dish.allergens.all %}
															<span {% if allergen in current_user.suffers_from.all %}class="badge text-danger"{% else %}class="badge"{% endif %}>
																<i class="{{ allergen.icon }}"></i>
																{{ allergen.name }}
															</span>
															{% endfor %}
														</div>
														{% endif %}
													</div>
												</div>
												{% endfor %}
											</div>
										</div>
										{% endfor %}
									</div>
									{% endfor %}
								</div>
							{% elif not day_data.is_open %}
								<div class="text-center py-4">
									<i class="fa-solid fa-lock text-muted mb-2" style="font-size: 2rem;"></i>
									<h4 class="text-muted">Mensa chiusa</h4>
									<p class="text-muted">La mensa è chiusa il {{ day_data.name }}.</p>
								</div>
							{% else %}
								<div class="text-center py-4">
									<i class="fa-solid fa-utensils text-muted mb-2" style="font-size: 2rem;"></i>
									<p class="text-muted">Menu non ancora disponibile per {{ day_data.name }}.</p>
								</div>
							{% endif %}
						</div>
						{% endfor %}
					</div>
				{% else %}
				<div class="no-menu-message">
					<i class="fa-solid fa-calendar-xmark"></i>
					<p>Menu settimanale non ancora disponibile. Torna più tardi per vedere cosa abbiamo preparato!</p>
				</div>
				{% endif %}
			</div>

		</div>
		
		<!-- Right Column - Opening Hours, Contact, Amenities -->
		<div class="col-lg-4">
			<!-- Opening Hours -->
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">Quando siamo aperti</small>
				<h3 class="section-title mb-3">Opening Hours</h3>
				<table class="hours-table">
					{% for weekday, day_data in weekly_menus.items %}
					<tr>
						{% if day_data.is_today %}
						<td class="text-primary"><strong>{{ day_data.name }}</strong></td>
						{% else %}
						<td><strong>{{ day_data.name }}</strong></td>
						{% endif %}
						<td>
							{% for hour in mensa.hours_set.all %}
								{% if hour.weekday == weekday %}
									{{ hour.open_time|time:"H:i" }} - {{ hour.close_time|time:"H:i" }}
									{% if not forloop.last %}<br>{% endif %}
								{% endif %}
							{% endfor %}
							{% if not day_data.is_open %}
								<span class="text-muted	">Chiuso</span>
							{% endif %}
						</td>
					</tr>
					{% empty %}
					<tr>
						<td colspan="2">Orari non disponibili</td>
					</tr>
					{% endfor %}
				</table>
			</div>

			<!-- Amenities Section -->
			 {% if mensa.amenities.all %}
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">I nostri servizi</small>
				<h3 class="section-title mb-3">Amenities</h3>
				<div class="amenities-list">
					{% for amenity in mensa.amenities.all %}
					<div class="amenity-item">
						<i class="{{ amenity.icon }}"></i> {{ amenity.text }}
					</div>
					{% endfor %}
				</div>
			</div>
			{% endif %}
			
			<!-- Contact Info -->
			<div class="info-card">
				<small class="text-primary text-uppercase">Come contattarci</small>
				<h3 class="section-title mb-3">Contact</h3>
				{% if mensa.phone_number %}
				<a href="tel:{{ mensa.phone_number }}" class="contact-link" target="_blank">
					<i class="fa-solid fa-phone"></i>
					{{ mensa.phone_number }}
				</a>
				{% endif %}
				
				{% if mensa.email %}
				<a href="mailto:{{ mensa.email }}" class="contact-link" target="_blank">
					<i class="fa-solid fa-envelope"></i>
					{{ mensa.email }}
				</a>
				{% endif %}
				
				<a href="https://www.instagram.com/" class="contact-link" target="_blank">
					<i class="fa-brands fa-instagram"></i>
					Instagram
				</a>
				
				<a href="https://www.facebook.com/" class="contact-link" target="_blank">
					<i class="fa-brands fa-facebook"></i>
					Facebook
				</a>
			</div>
		</div>
	</div>
	
	<!-- Gallery Section - Full Width -->
	<div class="row">
		<div class="col-12">
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">Le nostre foto</small>
				<h2 class="section-title">Gallery</h2>
				<div class="gallery-container">
					{% for photo in mensa.gallery.all %}
					<div class="gallery-item" onclick="openLightbox({{ forloop.counter0 }})">
						<img src="{{ photo.img.url }}" alt="Gallery image {{ forloop.counter }}">
						<div class="gallery-overlay">
							<i class="fa-solid fa-magnifying-glass"></i>
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
	
	<!-- Lightbox Modal -->
	<div id="lightbox" class="lightbox" onclick="closeLightbox()">
		<div class="lightbox-content" onclick="event.stopPropagation()">
			<span class="lightbox-close" onclick="closeLightbox()">&times;</span>
			<button class="lightbox-prev" onclick="event.stopPropagation(); changeSlide(-1)">&#10094;</button>
			<button class="lightbox-next" onclick="event.stopPropagation(); changeSlide(1)">&#10095;</button>
			<img id="lightbox-image" src="" alt="Gallery image">
			<div class="lightbox-counter">
				<span id="current-image">1</span> / <span id="total-images">{{ mensa.gallery.all|length }}</span>
			</div>
		</div>
	</div>
	
	<!-- Reviews Section - Full Width -->
	<div class="row">
		<div class="col-12">
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">Feedback dei clienti</small>
				<h2 class="section-title">
					<span>Listing Reviews</span>
				</h2>
				
				<!-- Loop through reviews -->
				{% for review in mensa.review_set.all %}
				<div class="review-card">
					<div class="review-header">
						<img src="{{ review.user.profile_pic.url }}" class="reviewer-avatar" alt="{{ review.user.username }}">
						<div>
							<h5 class="mb-0">{{ review.user.username }}</h5>
							<div class="stars-display">
								{% for i in "12345" %}
								{% if forloop.counter <= review.stars %}
								<i class="fa-solid fa-star"></i>
								{% else %}
								<i class="fa-regular fa-star"></i>
								{% endif %}
								{% endfor %}
							</div>
							<span class="review-date">{{ review.user.date_joined|date }}</span>
						</div>
					</div>
					<p>{{ review.text }}</p>
				</div>
				{% empty %}
				<p>No reviews yet. Be the first to review this mensa!</p>
				{% endfor %}
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
	// Tab switch functions for day and meal type
	function switchDay(dayId, el) {
		// Deactivate all day tabs
		document.querySelectorAll('.menu-tab').forEach(tab => tab.classList.remove('active'));
		el.classList.add('active');
		// Hide all menu contents
		document.querySelectorAll('.menu-content').forEach(c => c.classList.remove('active'));
		var content = document.getElementById('menu-day-' + dayId);
		if (content) {
			content.classList.add('active');
			// Trigger first available (non-disabled) meal type tab in this day
			var typeTabs = content.querySelectorAll('.meal-tab:not(.disabled)');
			if (typeTabs.length > 0) {
				typeTabs[0].click();
			}
		}
	}

	function switchMeal(dayId, daypart, el) {
		var container = document.getElementById('menu-day-' + dayId);
		if (!container) return;
		// Activate meal tab
		container.querySelectorAll('.meal-tab').forEach(tab => tab.classList.remove('active'));
		el.classList.add('active');
		// Show corresponding meal content
		container.querySelectorAll('.meal-content').forEach(c => c.classList.remove('active'));
		var sel = document.getElementById('meal-' + dayId + '-' + daypart);
		if (sel) sel.classList.add('active');
	}

	// Gallery lightbox functions
	let currentImageIndex = 0;
	const galleryImages = [
		{% for photo in mensa.gallery.all %}
		"{{ photo.img.url }}"{% if not forloop.last %},{% endif %}
		{% endfor %}
	];

	function openLightbox(index) {
		currentImageIndex = index;
		const lightbox = document.getElementById('lightbox');
		const lightboxImage = document.getElementById('lightbox-image');
		const currentCounter = document.getElementById('current-image');
		
		console.log('Opening lightbox with index:', index, 'Total images:', galleryImages.length);
		
		if (galleryImages[currentImageIndex]) {
			lightboxImage.src = galleryImages[currentImageIndex];
			currentCounter.textContent = currentImageIndex + 1;
			lightbox.style.display = 'block';
			document.body.style.overflow = 'hidden';
		} else {
			console.error('No image found at index:', currentImageIndex);
		}
	}

	function closeLightbox() {
		const lightbox = document.getElementById('lightbox');
		lightbox.style.display = 'none';
		document.body.style.overflow = 'auto';
	}

	function changeSlide(direction) {
		console.log('Changing slide, direction:', direction, 'Current index:', currentImageIndex);
		
		currentImageIndex += direction;
		
		if (currentImageIndex >= galleryImages.length) {
			currentImageIndex = 0;
		} else if (currentImageIndex < 0) {
			currentImageIndex = galleryImages.length - 1;
		}
		
		console.log('New index:', currentImageIndex);
		
		const lightboxImage = document.getElementById('lightbox-image');
		const currentCounter = document.getElementById('current-image');
		
		if (galleryImages[currentImageIndex]) {
			lightboxImage.src = galleryImages[currentImageIndex];
			currentCounter.textContent = currentImageIndex + 1;
		} else {
			console.error('No image found at index:', currentImageIndex);
		}
	}

	// Keyboard navigation for lightbox
	document.addEventListener('keydown', function(e) {
		const lightbox = document.getElementById('lightbox');
		if (lightbox.style.display === 'block') {
			if (e.key === 'Escape') {
				closeLightbox();
			} else if (e.key === 'ArrowLeft') {
				changeSlide(-1);
			} else if (e.key === 'ArrowRight') {
				changeSlide(1);
			}
		}
	});

	// Debug helper function to see active elements
	function debugMenuState() {
		console.log('Active day menu:', document.querySelector('.menu-content.active')?.id);
		console.log('Active dish types:', Array.from(document.querySelectorAll('.menu-type-content.active')).map(el => el.id));
	}

	document.addEventListener('DOMContentLoaded', function() {
		// Force all menu content to be properly initialized on page load
		setTimeout(() => {
			// First try to find the active day tab (today if open)
			let activeTab = document.querySelector('.menu-tab.active:not(.disabled)');
			
			// If today is not available (closed) or no active tab, select the first available open day
			if (!activeTab) {
				activeTab = document.querySelector('.menu-tab:not(.disabled)');
			}
			
			if (activeTab) {
				// Remove any existing active classes
				document.querySelectorAll('.menu-tab').forEach(tab => tab.classList.remove('active'));
				document.querySelectorAll('.menu-content').forEach(content => content.classList.remove('active'));
				
				// Activate the selected tab
				activeTab.classList.add('active');
				activeTab.click();
			}
		}, 50);
		
		const map = L.map('map', {
			scrollWheelZoom: false,
			dragging: false
		}).setView([{{ mensa.latitude }}, {{ mensa.longitude }}], 15);

		map.addEventListener('click', function(event) {
			map.scrollWheelZoom.enable();
			map.dragging.enable();
			if (event.originalEvent) {
				event.originalEvent.stopPropagation();
			}
		});

		document.addEventListener('click', function(e) {
			if (!map.getContainer().contains(e.target)) {
				map.dragging.disable();
				map.scrollWheelZoom.disable();
			}
		});

		L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
			attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
			maxZoom: 19,
			minZoom: 13,
		}).addTo(map);

		// Add marker for the mensa
		const marker = L.marker([{{ mensa.latitude }}, {{ mensa.longitude }}]).addTo(map);
		marker.bindPopup(`
			<div>
				<img src="{{ mensa.banner.url }}" class="popup-image" alt="{{ mensa.name }}">
				<h5 class="mb-2">{{ mensa.name }}</h5>
				<p class="text-muted mb-0"><i class="fas fa-map-marker-alt me-1"></i> {{ mensa.position }}</p>
			</div>
		`, {
			closeButton: true,
			className: 'custom-popup'
		});
	});
	
	// Like/Unlike functionality for dishes
	document.addEventListener('click', function(e) {
		if (e.target.classList.contains('like-heart')) {
			e.preventDefault();
			e.stopPropagation();
			
			const heart = e.target;
			const dishId = heart.getAttribute('data-dish-id');
			const isLiked = heart.getAttribute('data-liked') === 'true';
			
			// Disable the heart temporarily to prevent double clicks
			heart.style.pointerEvents = 'none';
			
			// Send AJAX request
			fetch(`/mense/dish/${dishId}/like/`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
				},
			})
			.then(response => response.json())
			.then(data => {
				if (data.liked) {
					// Switch to filled heart
					heart.className = 'fa-solid fa-heart text-danger ms-1 like-heart';
					heart.setAttribute('data-liked', 'true');
					heart.setAttribute('title', 'Rimuovi dai preferiti');
				} else {
					// Switch to empty heart
					heart.className = 'fa-regular fa-heart text-muted ms-1 like-heart';
					heart.setAttribute('data-liked', 'false');
					heart.setAttribute('title', 'Aggiungi ai preferiti');
				}
				
				// Show feedback message (optional)
				console.log(data.message);
			})
			.catch(error => {
				console.error('Error:', error);
				// You could show an error message here
			})
			.finally(() => {
				// Re-enable the heart
				heart.style.pointerEvents = 'auto';
			});
		}
	});

	
</script>
{% endblock %}
