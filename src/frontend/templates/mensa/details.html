{% extends 'base.html' %}
{% load static %}

{% block title %}{{ mensa.name }}{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="{% static 'css/mensa-details.css' %}">
{% endblock %}
{% block nav_elements %}
<li class="nav-item">
	<a class="nav-link" href="#about">About</a>
</li>
<li class="nav-item">
	<a class="nav-link" href="#location">Location</a>
</li>
<li class="nav-item">
	<a class="nav-link" href="#menu">Menu</a>
</li>
<li class="nav-item">
	<a class="nav-link" href="#api">Info Smart</a>
</li>
<li class="nav-item">
	<a class="nav-link" href="#gallery">Gallery</a>
</li>
<li class="nav-item">
	<a class="nav-link" href="#reviews">Reviews</a>
</li>
{% if user.is_authenticated %}
<li class="nav-item dropdown ms-3">
	<a class="nav-link dropdown-toggle profile-btn px-3 py-1" href="#" id="navbarDropdown" role="button"
		data-bs-toggle="dropdown" aria-expanded="false">
		{{ user.first_name }} {{ user.last_name }}
	</a>
	<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
		<li><a class="dropdown-item" href="{% url 'profile' %}">Profile</a></li>
		<li><hr class="dropdown-divider"> </li>
		<li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
	</ul>
</li>
{% else %}
<div class="nav-item ms-3">
	<a class="btn login-btn px-3 py-1" href="{% url 'login' %}">Log In</a>
</div>
{% endif %}
{% endblock %}

{% block nav_mobile %}
<div class="dropdown d-lg-none">
{% if user.is_authenticated %}
	<a class="nav-link dropdown-toggle profile-btn px-3 py-1" href="#" id="navbarDropdown" role="button"
		data-bs-toggle="dropdown" aria-expanded="false">
		{{ user.first_name }} {{ user.last_name }}
	</a>
	
	<ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown" style="margin: 0">
		<li><a class="dropdown-item" href="{% url 'profile' %}">Profile</a></li>
		<li><hr class="dropdown-divider"> </li>
		<li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
	</ul>

{% else %}
<div class="nav-item ms-3">
	<a class="btn login-btn px-3 py-1" href="{% url 'login' %}">Log In</a>
</div>
{% endif %}
</div>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Restaurant Banner -->
<section class="restaurant-banner">
	<img src="{{ mensa.banner.url }}" alt="{{ mensa.name }}">
	<div class="restaurant-banner-overlay">
		<div class="container">
			<h1 class="fs-2 fw-bold">{{ mensa.name }}</h1>
			<p class="mb-0">
				<i class="fa-solid fa-location-dot me-2"></i>
				{{ mensa.position }}, {{ mensa.city.name }}
			</p>
			<span class="badge bg-light text-dark me-2 mt-3">
				{% for _ in "01234" %}
					{% if forloop.counter <= mensa.stars|default:0 %}
						<i class="fas fa-star text-warning"></i>
					{% else %}
						<i class="far fa-star text-muted"></i>
					{% endif %}
				{% endfor %}
				{{ mensa.review_set.all|length }} Reviews
			</span>
		</div>
	</div>
</section>

<div class="container py-4">
	<div class="row flex-column-reverse flex-lg-row">
		<!-- Left column - About, Location, Gallery -->
		<div class="col-lg-8">
			<!-- About Section -->
			<div class="info-card mb-4" id="about">
				<small class="text-primary text-uppercase">La nostra storia</small>
				<h2 class="section-title">About</h2>
				<p>{{ mensa.description }}</p>
			</div>
			
			<!-- Location Section -->
			<div class="info-card mb-4" id="location">
				<small class="text-primary text-uppercase">Dove ci troviamo</small>
				<h2 class="section-title">Location</h2>
				<div id="map" class="map-container">
					<!-- Map will be rendered here by Leaflet -->
				</div>
			</div>
	
			<!-- Weekly Menu Section -->
			<div class="info-card mb-4" id="menu">
				<small class="text-primary text-uppercase">La nostra settimana culinaria</small>
				<h2 class="section-title">Menu Settimanale</h2>
				
				{% if weekly_menus %}
					<div class="text-start mb-4">
						<p class="text-muted mb-0">Scopri cosa offriamo giorno per giorno nella nostra mensa.<br>Menu freschi preparati con ingredienti di qualità.</p>
					</div>
					
					<!-- Menu Tabs for Days -->
					<div class="menu-tab-container">
						{% for weekday, day_data in weekly_menus.items %}
						<button class="menu-tab {% if day_data.is_today %}active{% endif %} {% if not day_data.is_open %}disabled{% endif %}" 
								id="day-tab-{{ weekday }}"
								{% if day_data.is_open %}onclick="switchDay('{{ weekday }}', this)"{% endif %}
								type="button"
								{% if not day_data.is_open %}disabled{% endif %}>
							{{ day_data.name }}
							{% if day_data.is_today %}
								<span class="ms-1 badge bg-primary rounded-pill">Oggi</span>
							{% endif %}
							{% if not day_data.is_open %}
								<span class="ms-1 badge bg-secondary rounded-pill">Chiuso</span>
							{% endif %}
						</button>
						{% endfor %}
					</div>
					
					<!-- Menu Content per Day -->
					<div class="menu-container">
						{% for weekday, day_data in weekly_menus.items %}
						<div id="menu-day-{{ weekday }}" class="menu-content {% if day_data.is_today %}active{% endif %}">
							{% if day_data.is_open and day_data.menus %}
								<!-- Meal tabs: Always show both Pranzo and Cena -->
								<div class="meal-tab-container">
									<!-- Pranzo button -->
									<button class="meal-tab {% if 0 in day_data.available_dayparts %}{% if forloop.first %}active{% endif %}{% else %}disabled{% endif %}" 
											{% if 0 in day_data.available_dayparts %}onclick="switchMeal('{{ weekday }}', '0', this)"{% else %}disabled{% endif %}>
										<i class="fa-solid fa-sun me-1"></i>Pranzo
										{% if 0 not in day_data.available_dayparts %}
											<span class="ms-1 badge bg-secondary rounded-pill">Chiuso</span>
										{% endif %}
									</button>
									<!-- Cena button -->
									<button class="meal-tab {% if 1 in day_data.available_dayparts %}{% if 0 not in day_data.available_dayparts %}active{% endif %}{% else %}disabled{% endif %}" 
											{% if 1 in day_data.available_dayparts %}onclick="switchMeal('{{ weekday }}', '1', this)"{% else %}disabled{% endif %}>
										<i class="fa-solid fa-moon me-1"></i>Cena
										{% if 1 not in day_data.available_dayparts %}
											<span class="ms-1 badge bg-secondary rounded-pill">Chiuso</span>
										{% endif %}
									</button>
								</div>

								<div class="meal-content-wrapper">
									{% for menu in day_data.menus %}
									<div id="meal-{{ weekday }}-{{ menu.day_part_value }}" class="meal-content {% if forloop.first %}active{% endif %}">
										{% for dish_type, dishes in menu.dishes_by_type.items %}
										<div class="course-section">
											{% if dish_type == "Primo" %}
											<h3 class="menu-category">Primi Piatti</h3>
											{% elif dish_type == "Secondo" %}
											<h3 class="menu-category">Secondi Piatti</h3>
											{% elif dish_type == "Contorno" %}
											<h3 class="menu-category">Contorni</h3>
											{% elif dish_type == "Dessert/Frutta" %}
											<h3 class="menu-category">Dessert e Frutta</h3>
											{% endif %}
											<div class="dish-grid">
												{% for dish in dishes %}
												<div class="dish-card">
													{% if dish.img %}
													<div class="dish-photo">
														<img src="{{ dish.img.url }}" alt="{{ dish.name }}">
													</div>
													{% endif %}
													<div class="dish-desc">
														<div class="dish-title">
															{{ dish.name }}
															{% if user.is_authenticated %}
																{% if dish in current_user.likes.all %}
																	<i class="fa-solid fa-heart text-danger ms-1 like-heart" 
																	   data-dish-id="{{ dish.name }}" 
																	   data-liked="true" 
																	   style="cursor: pointer;" 
																	   title="Rimuovi dai preferiti"></i>
																{% else %}
																	<i class="fa-regular fa-heart text-muted ms-1 like-heart" 
																	   data-dish-id="{{ dish.name }}" 
																	   data-liked="false" 
																	   style="cursor: pointer;" 
																	   title="Aggiungi ai preferiti"></i>
																{% endif %}
															{% endif %}
														</div>
														<div class="dish-ingredients">{{ dish.description }}</div>
														{% if dish.allergens.exists %}
														<div class="dish-allergens">
															{% for allergen in dish.allergens.all %}
															<span {% if allergen in current_user.suffers_from.all %}class="badge text-danger"{% else %}class="badge"{% endif %}>
																<i class="{{ allergen.icon }}"></i>
																{{ allergen.name }}
															</span>
															{% endfor %}
														</div>
														{% endif %}
													</div>
												</div>
												{% endfor %}
											</div>
										</div>
										{% endfor %}
									</div>
									{% endfor %}
								</div>
							{% elif not day_data.is_open %}
								<div class="text-center py-4">
									<i class="fa-solid fa-lock text-muted mb-2" style="font-size: 2rem;"></i>
									<h4 class="text-muted">Mensa chiusa</h4>
									<p class="text-muted">La mensa è chiusa il {{ day_data.name }}.</p>
								</div>
							{% else %}
								<div class="text-center py-4">
									<i class="fa-solid fa-utensils text-muted mb-2" style="font-size: 2rem;"></i>
									<p class="text-muted">Menu non ancora disponibile per {{ day_data.name }}.</p>
								</div>
							{% endif %}
						</div>
						{% endfor %}
					</div>
				{% else %}
				<div class="no-menu-message">
					<i class="fa-solid fa-calendar-xmark"></i>
					<p>Menu settimanale non ancora disponibile. Torna più tardi per vedere cosa abbiamo preparato!</p>
				</div>
				{% endif %}
			</div>
		</div>

		<!-- Right Column - Opening Hours, Contact, Amenities -->
		<div class="col-lg-4">
			<!-- Opening Hours -->
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">Quando siamo aperti</small>
				<h3 class="section-title mb-3">Opening Hours</h3>
				<table class="hours-table">
					{% for weekday, day_data in weekly_menus.items %}
					<tr>
						{% if day_data.is_today %}
						<td class="text-primary"><strong>{{ day_data.name }}</strong></td>
						{% else %}
						<td><strong>{{ day_data.name }}</strong></td>
						{% endif %}
						<td>
							{% for hour in mensa.hours_set.all %}
								{% if hour.weekday == weekday %}
									{{ hour.open_time|time:"H:i" }} - {{ hour.close_time|time:"H:i" }}
									{% if not forloop.last %}<br>{% endif %}
								{% endif %}
							{% endfor %}
							{% if not day_data.is_open %}
								<span class="text-muted	">Chiuso</span>
							{% endif %}
						</td>
					</tr>
					{% empty %}
					<tr>
						<td colspan="2">Orari non disponibili</td>
					</tr>
					{% endfor %}
				</table>
			</div>

			<!-- Amenities Section -->
			 {% if mensa.amenities.all %}
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">I nostri servizi</small>
				<h3 class="section-title mb-3">Amenities</h3>
				<div class="amenities-list">
					{% for amenity in mensa.amenities.all %}
					<div class="amenity-item">
						<i class="{{ amenity.icon }}"></i> {{ amenity.text }}
					</div>
					{% endfor %}
				</div>
			</div>
			{% endif %}
			
			<!-- Contact Info -->
			<div class="info-card">
				<small class="text-primary text-uppercase">Come contattarci</small>
				<h3 class="section-title mb-3">Contact</h3>
				{% if mensa.phone_number %}
				<a href="tel:{{ mensa.phone_number }}" class="contact-link" target="_blank">
					<i class="fa-solid fa-phone"></i>
					{{ mensa.phone_number }}
				</a>
				{% endif %}
				
				{% if mensa.email %}
				<a href="mailto:{{ mensa.email }}" class="contact-link" target="_blank">
					<i class="fa-solid fa-envelope"></i>
					{{ mensa.email }}
				</a>
				{% endif %}
				
				<a href="https://www.instagram.com/" class="contact-link" target="_blank">
					<i class="fa-brands fa-instagram"></i>
					Instagram
				</a>
				
				<a href="https://www.facebook.com/" class="contact-link" target="_blank">
					<i class="fa-brands fa-facebook"></i>
					Facebook
				</a>
			</div>
		</div>
	</div>

	<!-- Info Smart Section -->
	<div id="api" class="row">
		<div class="col-12">
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">in tempo reale</small>
				<h2 class="section-title">
					Info Smart
					<span id="connection-status" class="status-indicator"></span>
				</h2>
				<p class="text-muted">Qui trovi informazioni smart in tempo reale sulla mensa: coda, attesa, tavoli e posti liberi.</p>
				<div id="mensa-info" class="mb-4">
				<!-- Qui verranno inserite le info (coda, attesa, tavoli liberi ecc.) -->
				</div>

				<div id="seat-visualization" class="mb-4">
					<!-- Qui verrà inserita la griglia dei tavoli via JavaScript -->
				</div>
			</div>
		</div>
	</div>
	
	<!-- Gallery Section - Full Width -->
	<div class="row" id="gallery">
		<div class="col-12">
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">Le nostre foto</small>
				<h2 class="section-title">Gallery</h2>
				<div class="gallery-container">
					{% for photo in mensa.gallery.all %}
					<div class="gallery-item" onclick="openLightbox({{ forloop.counter0 }})">
						<img src="{{ photo.img.url }}" alt="Gallery image {{ forloop.counter }}">
						<div class="gallery-overlay">
							<i class="fa-solid fa-magnifying-glass"></i>
						</div>
					</div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
	
	<!-- Lightbox Modal -->
	<div id="lightbox" class="lightbox" onclick="closeLightbox()">
		<div class="lightbox-content" onclick="event.stopPropagation()">
			<span class="lightbox-close" onclick="closeLightbox()">&times;</span>
			<button class="lightbox-prev" onclick="event.stopPropagation(); changeSlide(-1)">&#10094;</button>
			<button class="lightbox-next" onclick="event.stopPropagation(); changeSlide(1)">&#10095;</button>
			<img id="lightbox-image" src="" alt="Gallery image">
			<div class="lightbox-counter">
				<span id="current-image">1</span> / <span id="total-images">{{ mensa.gallery.all|length }}</span>
			</div>
		</div>
	</div>		<!-- Reviews Section - Full Width -->
	<div class="row" id="reviews">
		<div class="col-12">
			<div class="info-card mb-4">
				<small class="text-primary text-uppercase">Feedback dei clienti</small>
				<h2 class="section-title">
					<span>Listing Reviews</span>
				</h2>
				
				<!-- Add Review Form - Only if logged in and hasn't reviewed yet -->
				{% if user.is_authenticated %}
					{% if not user_has_reviewed %}
						<div class="review-form-card mb-4">
							<h4 class="mb-3">Scrivi una recensione</h4>
							<form id="review-form" method="post">
								{% csrf_token %}
								<div class="mb-3">
									<label class="form-label fw-bold">Valutazione</label>
									<div class="star-rating">
										<input type="radio" name="stars" value="5" id="star5">
										<label for="star5"><i class="fa-solid fa-star"></i></label>
										<input type="radio" name="stars" value="4" id="star4">
										<label for="star4"><i class="fa-solid fa-star"></i></label>
										<input type="radio" name="stars" value="3" id="star3">
										<label for="star3"><i class="fa-solid fa-star"></i></label>
										<input type="radio" name="stars" value="2" id="star2">
										<label for="star2"><i class="fa-solid fa-star"></i></label>
										<input type="radio" name="stars" value="1" id="star1">
										<label for="star1"><i class="fa-solid fa-star"></i></label>
									</div>
									<div id="stars-error" class="text-danger small mt-1" style="display: none;"></div>
								</div>
								
								<div class="mb-3">
									<label for="comment" class="form-label fw-bold">Commento (opzionale)</label>
									<textarea name="comment" id="comment" class="form-control" rows="4" placeholder="Condividi la tua esperienza..."></textarea>
								</div>
								
								<button type="submit" class="btn btn-primary">
									<i class="fa-solid fa-paper-plane me-2"></i>Invia Recensione
								</button>
							</form>
						</div>
					{% endif %}
				{% else %}
					<div class="review-form-card mb-4">
						<p class="text-muted">
							<i class="fa-solid fa-user me-2"></i>
							<a href="{% url 'login' %}?next={{ request.path|urlencode }}" class="text-primary">Accedi</a> per scrivere una recensione.
						</p>
					</div>
				{% endif %}
				
				<!-- Loop through reviews -->
				{% for review in reviews %}
				<div class="review-card" data-review-id="{{ review.id }}">
					<div class="review-header">
						<img src="{{ review.user.propic.url }}" class="reviewer-avatar" alt="{{ review.user.get_full_name }}">
						<div class="flex-grow-1">
							<h5 class="mb-0">{{ review.user.get_full_name }}</h5>
							<div class="stars-display">
								{% for i in "12345" %}
								{% if forloop.counter <= review.stars %}
								<i class="fa-solid fa-star"></i>
								{% else %}
								<i class="fa-regular fa-star"></i>
								{% endif %}
								{% endfor %}
							</div>
							<span class="review-date">{{ review.date|date }}</span>
						</div>
						{% if current_user.is_authenticated and review.user == current_user %}
						<div class="review-actions">
							<button class="btn btn-outline-danger btn-sm delete-review-btn" data-mensa-name="{{ mensa.name }}" title="Elimina recensione">
								<i class="fa-solid fa-trash"></i>
							</button>
						</div>
						{% endif %}
					</div>
					<p>{{ review.text }}</p>
				</div>
				{% empty %}
				<p>No reviews yet. Be the first to review this mensa!</p>
				{% endfor %}
			</div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
	/* INFO SMART */
  // Intervallo di aggiornamento in millisecondi
  const UPDATE_INTERVAL_MS = 1000;  // ogni 0.5 secondi

  // Nome mensa dal context Django
  const mensaName = "{{ mensa.name }}";
  const apiUrl = `/api/${encodeURIComponent(mensaName)}/`;

  /**
   * Mostra le info generali della mensa:
   *  - queue_len
   *  - wait_time (in secondi)
   *  - free_tables
   *  - free_seats
   *  - pct_free_seats
   */
  function renderMensaInfo(data) {
    const infoDiv = document.getElementById("mensa-info");
    infoDiv.innerHTML = "";

    // Creiamo un contenitore a riga
    const row = document.createElement("div");
    row.style.display = "flex";
    row.style.flexWrap = "wrap";
    row.style.gap = "16px";

    // Funzione di utilità per creare una card info
    function makeCard(label, value) {
      const card = document.createElement("div");
      card.style.padding = "8px 12px";
      card.style.border = "1px solid #ccc";
      card.style.borderRadius = "4px";
      card.style.backgroundColor = "#f8f9fa";
      card.style.minWidth = "120px";
      card.style.textAlign = "center";

      const lbl = document.createElement("div");
      lbl.style.fontSize = "0.8rem";
      lbl.style.color = "#555";
      lbl.textContent = label;

      const val = document.createElement("div");
      val.style.fontSize = "1.2rem";
      val.style.fontWeight = "bold";
      val.style.marginTop = "4px";
      val.textContent = value;

      card.appendChild(lbl);
      card.appendChild(val);
      return card;
    }

    // Aggiungiamo le card con i dati
    row.appendChild(makeCard("In coda", data.queue_len));
    row.appendChild(makeCard("Attesa (s)", data.wait_time));
    row.appendChild(makeCard("Tavoli liberi", data.free_tables));
    row.appendChild(makeCard("Posti liberi", data.free_seats));
    row.appendChild(makeCard("% posti liberi", data.pct_free_seats + "%"));

    infoDiv.appendChild(row);
  }

  /**
   * Disegna la griglia dei tavoli per ogni blocco in 5 colonne × 2 righe.
   */
  function renderSeats(blockList) {
    const container = document.getElementById("seat-visualization");
    container.innerHTML = "";

    blockList.forEach((block, blockIndex) => {
      const blockLetter = String.fromCharCode(65 + blockIndex);

      const blockDiv = document.createElement("div");
      blockDiv.classList.add("mb-3");

      // Titolo del blocco
      const title = document.createElement("h5");
      title.textContent = `Block ${blockLetter}`;
      blockDiv.appendChild(title);

      // Griglia 5 colonne × 2 righe (10 tavoli)
      const grid = document.createElement("div");
      grid.style.display = "grid";
      grid.style.gridTemplateColumns = "repeat(5, 1fr)";
      grid.style.gridAutoRows = "50px";
      grid.style.gap = "8px";

      block.forEach((table, tableIndex) => {
        const occupiedCount = table.reduce((sum, seat) => sum + seat, 0);
        let bgColor;
        if (occupiedCount === 0) {
          bgColor = "#d4edda";      // verde chiaro
        } else if (occupiedCount === 1) {
          bgColor = "#fff3cd";      // giallo chiaro
        } else if (occupiedCount <= 3) {
          bgColor = "#ffe5b4";      // arancione chiaro
        } else {
          bgColor = "#f8d7da";      // rosso chiaro
        }

        const tableDiv = document.createElement("div");
        tableDiv.style.backgroundColor = bgColor;
        tableDiv.style.border = "1px solid #666";
        tableDiv.style.borderRadius = "4px";
        tableDiv.style.display = "flex";
        tableDiv.style.alignItems = "center";
        tableDiv.style.justifyContent = "center";
        tableDiv.style.fontSize = "0.9rem";
        tableDiv.style.fontWeight = "bold";
        tableDiv.style.color = "#333";

        const identifier = `${blockLetter}${tableIndex + 1}`;
        tableDiv.textContent = identifier;

        grid.appendChild(tableDiv);
      });

      blockDiv.appendChild(grid);
      container.appendChild(blockDiv);
    });
  }

  /**
   * Fetch ai dati API e render sia delle info generali che della griglia tavoli.
*/
  async function fetchAndRender() {
	console.log("FETCH");
const statusIndicator = document.getElementById('connection-status');
 try {
	const response = await fetch(apiUrl);
	if (!response.ok) throw new Error("Status " + response.status);
	const data = await response.json();

	renderMensaInfo(data);  // mostro le card delle info
	renderSeats(data.block_list);            // mostro la griglia dei tavoli

  statusIndicator.classList.remove('error');
  statusIndicator.style.backgroundColor = 'green';
  statusIndicator.style.animation = 'pulse 1.5s infinite';

	// Rimuovi eventuale alert precedente
	let oldAlert = document.getElementById('mensa-info-alert');
	if (oldAlert) oldAlert.remove();
 } catch (err) {
  statusIndicator.classList.add('error');
  statusIndicator.style.backgroundColor = 'red';
  statusIndicator.style.animation = 'none';
  // Mostra alert sotto le info
  let infoDiv = document.getElementById("mensa-info");
  let oldAlert = document.getElementById('mensa-info-alert');
  if (oldAlert) oldAlert.remove();
  const alert = document.createElement('div');
  alert.className = 'alert alert-danger mt-2';
  alert.id = 'mensa-info-alert';
  alert.role = 'alert';
  alert.innerHTML = 'Impossibile recuperare le informazioni in tempo reale. Riprova più tardi.';
  infoDiv.parentNode.insertBefore(alert, infoDiv.nextSibling);
}
  }

  {% comment %} document.addEventListener("DOMContentLoaded", () => {
    fetchAndRender();
    setInterval(fetchAndRender, UPDATE_INTERVAL_MS);
  }); {% endcomment %}
</script>

<script>
// Funzione per verificare la visibilità della sezione "Info Smart"
let fetchInterval;

function observeInfoSmartSection() {
    const infoSmartSection = document.getElementById('api');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                // La sezione è visibile, avvia l'intervallo di aggiornamento
                fetchAndRender();
                fetchInterval = setInterval(fetchAndRender, UPDATE_INTERVAL_MS);
            } else {
                // La sezione non è più visibile, ferma l'intervallo
                clearInterval(fetchInterval);
            }
        });
    });

    observer.observe(infoSmartSection);
}

// Avvia l'osservazione quando la pagina è caricata
document.addEventListener('DOMContentLoaded', observeInfoSmartSection);
</script>





<script>
	// Tab switch functions for day and meal type
	function switchDay(dayId, el) {
		// Deactivate all day tabs
		document.querySelectorAll('.menu-tab').forEach(tab => tab.classList.remove('active'));
		el.classList.add('active');
		// Hide all menu contents
		document.querySelectorAll('.menu-content').forEach(c => c.classList.remove('active'));
		var content = document.getElementById('menu-day-' + dayId);
		if (content) {
			content.classList.add('active');
			// Trigger first available (non-disabled) meal type tab in this day
			var typeTabs = content.querySelectorAll('.meal-tab:not(.disabled)');
			if (typeTabs.length > 0) {
				typeTabs[0].click();
			}
		}
	}

	function switchMeal(dayId, daypart, el) {
		var container = document.getElementById('menu-day-' + dayId);
		if (!container) return;
		// Activate meal tab
		container.querySelectorAll('.meal-tab').forEach(tab => tab.classList.remove('active'));
		el.classList.add('active');
		// Show corresponding meal content
		container.querySelectorAll('.meal-content').forEach(c => c.classList.remove('active'));
		var sel = document.getElementById('meal-' + dayId + '-' + daypart);
		if (sel) sel.classList.add('active');
	}

	// Gallery lightbox functions
	let currentImageIndex = 0;
	const galleryImages = [
		{% for photo in mensa.gallery.all %}
		"{{ photo.img.url }}"{% if not forloop.last %},{% endif %}
		{% endfor %}
	];

	function openLightbox(index) {
		currentImageIndex = index;
		const lightbox = document.getElementById('lightbox');
		const lightboxImage = document.getElementById('lightbox-image');
		const currentCounter = document.getElementById('current-image');
		
		console.log('Opening lightbox with index:', index, 'Total images:', galleryImages.length);
		
		if (galleryImages[currentImageIndex]) {
			lightboxImage.src = galleryImages[currentImageIndex];
			currentCounter.textContent = currentImageIndex + 1;
			lightbox.style.display = 'block';
			document.body.style.overflow = 'hidden';
		} else {
			console.error('No image found at index:', currentImageIndex);
		}
	}

	function closeLightbox() {
		const lightbox = document.getElementById('lightbox');
		lightbox.style.display = 'none';
		document.body.style.overflow = 'auto';
	}

	function changeSlide(direction) {
		console.log('Changing slide, direction:', direction, 'Current index:', currentImageIndex);
		
		currentImageIndex += direction;
		
		if (currentImageIndex >= galleryImages.length) {
			currentImageIndex = 0;
		} else if (currentImageIndex < 0) {
			currentImageIndex = galleryImages.length - 1;
		}
		
		console.log('New index:', currentImageIndex);
		
		const lightboxImage = document.getElementById('lightbox-image');
		const currentCounter = document.getElementById('current-image');
		
		if (galleryImages[currentImageIndex]) {
			lightboxImage.src = galleryImages[currentImageIndex];
			currentCounter.textContent = currentImageIndex + 1;
		} else {
			console.error('No image found at index:', currentImageIndex);
		}
	}

	// Keyboard navigation for lightbox
	document.addEventListener('keydown', function(e) {
		const lightbox = document.getElementById('lightbox');
		if (lightbox.style.display === 'block') {
			if (e.key === 'Escape') {
				closeLightbox();
			} else if (e.key === 'ArrowLeft') {
				changeSlide(-1);
			} else if (e.key === 'ArrowRight') {
				changeSlide(1);
			}
		}
	});

	// Debug helper function to see active elements
	function debugMenuState() {
		console.log('Active day menu:', document.querySelector('.menu-content.active')?.id);
		console.log('Active dish types:', Array.from(document.querySelectorAll('.menu-type-content.active')).map(el => el.id));
	}

	document.addEventListener('DOMContentLoaded', function() {
		// Force all menu content to be properly initialized on page load
		setTimeout(() => {
			// First try to find the active day tab (today if open)
			let activeTab = document.querySelector('.menu-tab.active:not(.disabled)');
			
			// If today is not available (closed) or no active tab, select the first available open day
			if (!activeTab) {
				activeTab = document.querySelector('.menu-tab:not(.disabled)');
			}
			
			if (activeTab) {
				// Remove any existing active classes
				document.querySelectorAll('.menu-tab').forEach(tab => tab.classList.remove('active'));
				document.querySelectorAll('.menu-content').forEach(content => content.classList.remove('active'));
				
				// Activate the selected tab
				activeTab.classList.add('active');
				activeTab.click();
			}
		}, 50);
		
		const map = L.map('map', {
			scrollWheelZoom: false,
			dragging: false
		}).setView([{{ mensa.latitude|default:"0" }}, {{ mensa.longitude|default:"0" }}], 15);

		map.addEventListener('click', function(event) {
			map.scrollWheelZoom.enable();
			map.dragging.enable();
			if (event.originalEvent) {
				event.originalEvent.stopPropagation();
			}
		});

		document.addEventListener('click', function(e) {
			if (!map.getContainer().contains(e.target)) {
				map.dragging.disable();
				map.scrollWheelZoom.disable();
			}
		});

		L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
			attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors © <a href="https://carto.com/attributions">CARTO</a>',
			maxZoom: 19,
			minZoom: 13,
		}).addTo(map);

		// Add marker for the mensa
		const marker = L.marker([{{ mensa.latitude|default:"0" }}, {{ mensa.longitude|default:"0" }}]).addTo(map);
		marker.bindPopup(`
			<div>
				<img src="{{ mensa.banner.url }}" class="popup-image" alt="{{ mensa.name }}">
				<h5 class="mb-2">{{ mensa.name }}</h5>
				<p class="text-muted mb-0"><i class="fas fa-map-marker-alt me-1"></i> {{ mensa.position }}</p>
			</div>
		`, {
			closeButton: true,
			className: 'custom-popup'
		});
	});
	
	// Like/Unlike functionality for dishes
	document.addEventListener('click', function(e) {
		if (e.target.classList.contains('like-heart')) {
			e.preventDefault();
			e.stopPropagation();
			
			const heart = e.target;
			const dishId = heart.getAttribute('data-dish-id');
			const isLiked = heart.getAttribute('data-liked') === 'true';
			
			// Disable the heart temporarily to prevent double clicks
			heart.style.pointerEvents = 'none';
			
			// Send AJAX request
			fetch(`/mense/dish/${dishId}/like/`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
				},
			})
			.then(response => response.json())
			.then(data => {
				if (data.liked) {
					// Switch to filled heart
					heart.className = 'fa-solid fa-heart text-danger ms-1 like-heart';
					heart.setAttribute('data-liked', 'true');
					heart.setAttribute('title', 'Rimuovi dai preferiti');
				} else {
					// Switch to empty heart
					heart.className = 'fa-regular fa-heart text-muted ms-1 like-heart';
					heart.setAttribute('data-liked', 'false');
					heart.setAttribute('title', 'Aggiungi ai preferiti');
				}
				
				// Show feedback message (optional)
				console.log(data.message);
			})
			.catch(error => {
				console.error('Error:', error);
				// You could show an error message here
			})
			.finally(() => {
				// Re-enable the heart
				heart.style.pointerEvents = 'auto';
			});
		}
	});

	// Function to handle review deletion
	function handleDeleteReview(e) {
		e.preventDefault();
		const deleteBtn = e.target.closest('.delete-review-btn');
		const mensaName = deleteBtn.getAttribute('data-mensa-name');
		const reviewCard = deleteBtn.closest('.review-card');
		
		// Show the delete confirmation modal
		const deleteModal = new bootstrap.Modal(document.getElementById('deleteReviewModal'));
		deleteModal.show();
		
		// Set up the confirm button click handler
		document.getElementById('confirmDeleteBtn').onclick = function() {
			// close popup
			deleteModal.hide();

			// Confirm deletion
			// Disable button and show loading
			deleteBtn.disabled = true;
			deleteBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
			
			// Prepare form data
			const formData = new FormData();
			formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
			
			// Send AJAX request
			fetch('{% url "remove_review" mensa.name %}', {
				method: 'POST',
				headers: {
					'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
				},
				body: formData
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					// Remove the review card with animation
					reviewCard.style.transition = 'opacity 0.3s ease';
					reviewCard.style.opacity = '0';
					setTimeout(() => {
						reviewCard.remove();
						
						// Show review form again if user just deleted their review and no form exists
						const reviewFormCard = document.querySelector('.review-form-card');
						if (!reviewFormCard) {
							// Create a new form container
							const reviewsContainer = document.querySelector('#reviews .info-card');
							const formHTML = `
								<div class="review-form-card mb-4">
									<h4 class="mb-3">Scrivi una recensione</h4>
									<form id="review-form" method="post">
										{% csrf_token %}
										
										<div class="mb-3">
											<label class="form-label fw-bold">Valutazione</label>
											<div class="star-rating">
												<input type="radio" name="stars" value="5" id="star5">
												<label for="star5"><i class="fa-solid fa-star"></i></label>
												<input type="radio" name="stars" value="4" id="star4">
												<label for="star4"><i class="fa-solid fa-star"></i></label>
												<input type="radio" name="stars" value="3" id="star3">
												<label for="star3"><i class="fa-solid fa-star"></i></label>
												<input type="radio" name="stars" value="2" id="star2">
												<label for="star2"><i class="fa-solid fa-star"></i></label>
												<input type="radio" name="stars" value="1" id="star1">
												<label for="star1"><i class="fa-solid fa-star"></i></label>
											</div>
											<div id="stars-error" class="text-danger small mt-1" style="display: none;"></div>
										</div>
										
										<div class="mb-3">
											<label for="comment" class="form-label fw-bold">Commento (opzionale)</label>
											<textarea name="comment" id="comment" class="form-control" rows="4" placeholder="Condividi la tua esperienza..."></textarea>
										</div>
										
										<button type="submit" class="btn btn-primary">
											<i class="fa-solid fa-paper-plane me-2"></i>Invia Recensione
										</button>
									</form>
								</div>
							`;
							
							// Insert the form after the title
							const titleElement = reviewsContainer.querySelector('.section-title');
							if (titleElement) {
								titleElement.insertAdjacentHTML('afterend', formHTML);
							}
							
							// Reinitialize the review form functionality
							initializeReviewForm();
						}
					}, 300);
					
				} else {
					console.error('Error deleting review:', data.message);
					
					// Re-enable button
					deleteBtn.disabled = false;
					deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
				}
			})
			.catch(error => {
				console.error('Error:', error);
				
				// Re-enable button
				deleteBtn.disabled = false;
				deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
			});
		}
	}

	// Initialize review form functionality
	function initializeReviewForm() {
		const reviewForm = document.getElementById('review-form');
		const starInputs = document.querySelectorAll('input[name="stars"]');
		const starLabels = document.querySelectorAll('.star-rating label');
		const starsError = document.getElementById('stars-error');
		
		if (!reviewForm) return; // Exit if form doesn't exist
		
		// Star rating interaction
		starLabels.forEach((label, index) => {
			label.addEventListener('mouseover', function() {
				highlightStars(starLabels.length - index);
			});
			
			label.addEventListener('mouseout', function() {
				const checkedStar = document.querySelector('input[name="stars"]:checked');
				if (checkedStar) {
					highlightStars(parseInt(checkedStar.value));
				} else {
					highlightStars(0);
				}
			});
			
			label.addEventListener('click', function() {
				const value = starLabels.length - index;
				document.getElementById(`star${value}`).checked = true;
				highlightStars(value);
				if (starsError) {
					starsError.style.display = 'none';
				}
			});
		});
		
		function highlightStars(rating) {
			starLabels.forEach((label, index) => {
				const star = label.querySelector('i');
				if (starLabels.length - index <= rating) {
					star.classList.remove('fa-regular');
					star.classList.add('fa-solid');
					star.style.color = '#ffc107';
				} else {
					star.classList.remove('fa-solid');
					star.classList.add('fa-regular');
					star.style.color = '#dee2e6';
				}
			});
		}
		
		// Form submission
		reviewForm.addEventListener('submit', function(e) {
			e.preventDefault();
			
			// Client-side validation
			const selectedStar = document.querySelector('input[name="stars"]:checked');
			if (!selectedStar) {
				if (starsError) {
					starsError.textContent = 'Seleziona una valutazione dalle stelle';
					starsError.style.display = 'block';
				}
				return;
			}
			
			if (starsError) {
				starsError.style.display = 'none';
			}
			
			// Disable submit button to prevent double submission
			const submitBtn = reviewForm.querySelector('button[type="submit"]');
			const originalText = submitBtn.innerHTML;
			submitBtn.disabled = true;
			submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>Invio in corso...';
			
			// Prepare form data
			const formData = new FormData(reviewForm);
			
			// Send AJAX request
			fetch('{% url "add_review" mensa.name %}', {
				method: 'POST',
				headers: {
					'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
				},
				body: formData
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					// Get form data to create the new review element
					const selectedStar = document.querySelector('input[name="stars"]:checked');
					const stars = selectedStar ? selectedStar.value : 0;
					const comment = document.getElementById('comment').value;
					const userFullName = '{{ current_user.get_full_name }}';
					const userPropic = '{% if current_user.propic %}{{ current_user.propic.url }}{% else %}/static/imgs/default-avatar.png{% endif %}';
					const currentDate = new Date().toLocaleDateString('en-US', { 
						year: 'numeric', 
						month: 'short', 
						day: 'numeric' 
					});
					
					// Create new review HTML
					const newReviewHTML = `
						<div class="review-card" data-review-id="new-review">
							<div class="review-header">
								<img src="${userPropic}" class="reviewer-avatar" alt="${userFullName}">
								<div class="flex-grow-1">
									<h5 class="mb-0">${userFullName}</h5>
									<div class="stars-display">
										${Array.from({length: 5}, (_, i) => 
											i < stars ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star"></i>'
										).join('')}
									</div>
									<span class="review-date">${currentDate}</span>
								</div>
								<div class="review-actions">
									<button class="btn btn-outline-danger btn-sm delete-review-btn" data-mensa-name="{{ mensa.name }}" title="Elimina recensione">
										<i class="fa-solid fa-trash"></i>
									</button>
								</div>
							</div>
							<p>${comment}</p>
						</div>
					`;
					
					// Add the new review at the top of the reviews list
					const reviewsContainer = document.querySelector('#reviews .info-card');
					if (!reviewsContainer) {
						console.error('Reviews container not found');
						return;
					}
					
					// Insert new review at the beginning of reviews
					const existingReviews = reviewsContainer.querySelector('.review-card');
					if (existingReviews) {
						existingReviews.insertAdjacentHTML('beforebegin', newReviewHTML);
					} else {
						// If no reviews exist, replace the "No reviews yet" message
						const noReviewsMsg = reviewsContainer.querySelector('p');
						if (noReviewsMsg && noReviewsMsg.textContent.includes('No reviews yet')) {
							noReviewsMsg.remove();
						}
						reviewsContainer.insertAdjacentHTML('beforeend', newReviewHTML);
					}
					
					// Hide the review form since user has now reviewed
					const reviewFormCard = document.querySelector('.review-form-card');
					if (reviewFormCard) {
						reviewFormCard.remove();
					}
				} else {
					// Show form errors if any
					if (data.errors) {
						console.error('Form errors:', data.errors);
					}
				}
			})
			.catch(error => {
				console.error('Error:', error);
			})
			.finally(() => {
				// Re-enable submit button
				submitBtn.disabled = false;
				submitBtn.innerHTML = originalText;
			});
		});
		
		// Initialize star display
		const checkedStar = document.querySelector('input[name="stars"]:checked');
		if (checkedStar) {
			highlightStars(parseInt(checkedStar.value));
		} else {
			highlightStars(0);
		}
	}

	// Review form functionality
	document.addEventListener('DOMContentLoaded', function() {
		// Initialize the review form on page load
		initializeReviewForm();
	});

	// Delete review functionality - Use event delegation for dynamic content
	document.addEventListener('click', function(e) {
		if (e.target.closest('.delete-review-btn')) {
			handleDeleteReview(e);
		}
	});
	
</script>

<!-- Delete Review Confirmation Modal -->
<div class="modal fade" id="deleteReviewModal" tabindex="-1" aria-labelledby="deleteReviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteReviewModalLabel">
                    <i class="fa-solid fa-exclamation-triangle text-warning me-2"></i>
                    Conferma eliminazione
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Sei sicuro di voler eliminare questa recensione? Questa azione non può essere annullata.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-times me-1"></i>Annulla
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fa-solid fa-trash me-1"></i>Elimina recensione
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}